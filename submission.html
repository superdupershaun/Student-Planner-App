<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 64rem;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .label {
            display: block;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .input-field {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            appearance: none;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            width: 100%;
            padding: 0.5rem 0.75rem;
            color: #374151;
            line-height: 1.25;
            outline: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn {
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-blue {
            background-color: #2563eb;
            color: #ffffff;
        }
        .btn-blue:hover {
            background-color: #1d4ed8;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-green {
            background-color: #10b981;
            color: #ffffff;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-yellow {
            background-color: #f59e0b;
            color: #ffffff;
        }
        .btn-yellow:hover {
            background-color: #d97706;
        }
        .btn-red {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        .btn-gray {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }
        .color-picker-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            border: 2px solid #d1d5db;
            cursor: pointer;
            transition: border-color 0.15s ease-in-out, ring-width 0.15s ease-in-out, ring-color 0.15s ease-in-out;
        }
        .color-picker-btn.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .calendar-day {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 7.5rem;
        }
        .calendar-day h3 {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }
        .student-item {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-align: center;
        }
        .student-time {
            display: block;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(75, 85, 99, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 24rem;
            width: 100%;
            text-align: center;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .modal-content p {
            color: #374151;
            margin-bottom: 1.5rem;
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            border-bottom-color: #3b82f6;
            animation: spin 1s linear infinite;
            border-radius: 9999px;
            height: 4rem;
            width: 4rem;
            border-width: 4px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Custom Slider Styles for Temperature Gauge */
        .temperature-gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 0.5rem;
        }
        .temperature-gauge-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .temperature-gauge-labels span {
            flex: 1;
            text-align: center;
        }
        .temperature-gauge-labels span:first-child { text-align: left; }
        .temperature-gauge-labels span:last-child { text-align: right; }

        .temperature-gauge-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 1rem;
            border-radius: 0.5rem;
            background: linear-gradient(to right, #3b82f6, #facc15, #ef4444); /* Cold to Hot gradient */
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .temperature-gauge-slider:hover {
            opacity: 1;
        }

        /* Default slider thumb (Cold) */
        .temperature-gauge-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: #BFDBFE; /* Light blue for cold */
            border: 2px solid #60A5FA; /* Blue border */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .temperature-gauge-slider::-moz-range-thumb {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: #BFDBFE; /* Light blue for cold */
            border: 2px solid #60A5FA; /* Blue border */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Styles for the "Warm" slider thumb */
        .temperature-gauge-slider.slider-warm-value::-webkit-slider-thumb {
            background: #FDE68A; /* Light yellow/gold for warm */
            border-color: #FBBF24; /* Orange border */
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.5); /* Subtle glow */
        }
        .temperature-gauge-slider.slider-warm-value::-moz-range-thumb {
            background: #FDE68A; /* Light yellow/gold for warm */
            border-color: #FBBF24; /* Orange border */
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.5); /* Subtle glow */
        }

        /* Styles for the "Hot" slider thumb */
        .temperature-gauge-slider.slider-hot-value::-webkit-slider-thumb {
            background: #FF4500; /* OrangeRed */
            border-color: #DC143C; /* Crimson */
            box-shadow: 0 0 0 4px rgba(255, 69, 0, 0.5); /* Fiery glow */
        }
        .temperature-gauge-slider.slider-hot-value::-moz-range-thumb {
            background: #FF4500; /* OrangeRed */
            border-color: #DC143C; /* Crimson */
            box-shadow: 0 0 0 4px rgba(255, 69, 0, 0.5); /* Fiery glow */
        }

        /* Ensure default thumb style is 'cold' if no specific class is applied */
        .temperature-gauge-slider.slider-cold-value::-webkit-slider-thumb {
            background: #BFDBFE; /* Light blue for cold */
            border-color: #60A5FA; /* Blue border */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .temperature-gauge-slider.slider-cold-value::-moz-range-thumb {
            background: #BFDBFE; /* Light blue for cold */
            border-color: #60A5FA; /* Blue border */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .current-proficiency-display {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-top: 0.5rem;
            text-align: center;
            width: 100%;
        }

        .explanation-bar {
            width: 100%;
            height: 1rem;
            border-radius: 0.5rem;
            background: linear-gradient(to right, #3b82f6, #facc15, #ef4444);
            margin-bottom: 0.5rem;
        }
        .explanation-text {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align text and emojis vertically */
            width: 100%;
            font-size: 0.75rem;
            color: #4b5563;
            margin-bottom: 1rem;
        }
        .explanation-text span {
            flex: 1;
            text-align: center;
            display: flex; /* Use flex to align text and emoji */
            flex-direction: column; /* Stack text and emoji */
            align-items: center; /* Center content within span */
        }
        .explanation-text span:first-child { text-align: left; align-items: flex-start; }
        .explanation-text span:last-child { text-align: right; align-items: flex-end; }

        .explanation-emoji {
            font-size: 2rem; /* Make emojis bigger */
            line-height: 1; /* Adjust line height to prevent extra space */
            margin-bottom: 0.25rem; /* Space between emoji and text */
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div id="loading-spinner" class="flex flex-col items-center justify-center h-64">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-lg text-gray-700">Loading planner...</p>
            <p class="text-sm text-gray-500 mt-2">Please wait while we connect to your data.</p>
        </div>
    </div>

    <script type="module">
        // Firebase imports using ES Modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let app;
        let db;
        let auth;
        let userId = null;
        let userEmail = null; // New: To store user's email
        let isAuthReady = false;
        let isLoadingLLM = false; // New: To control LLM loading spinner
        let llmOutputModalMessage = ''; // New: For LLM output modal
        let showLlmOutputModalState = false; // Renamed to avoid conflict with function name

        // Utility function to escape characters that could break HTML or JavaScript contexts
        function escapeTemplateLiteral(str) {
            if (typeof str !== 'string') return str;
            // Escape backticks for JS template literals
            // Escape HTML special characters for insertion into HTML content/attributes
            return str.replace(/`/g, '\\`') // Escape backticks for JS template strings
                      .replace(/"/g, '&quot;') // Escape double quotes for HTML attributes
                      .replace(/'/g, '&#39;'); // Escape single quotes for HTML attributes
        }

        // IMPORTANT: Replace "AIzaSyATxeJJ7j2HcYm7Ca2ThVtz9HabuQjmHbA" and "1:21096957752:web:0cf6a8d3556b40cb57a3cd"
        // with your actual Firebase Web API Key and App ID from your Firebase project settings.
        const firebaseConfig = {
            apiKey: "AIzaSyATxeJJ7j2HcYm7Ca2ThVtz9HabuQjmHbA",
            authDomain: "private-lessons-ab22f.firebaseapp.com",
            projectId: "private-lessons-ab22f",
            storageBucket: "private-lessons-ab22f.firebasestorage.app",
            messagingSenderId: "21096957752",
            appId: "1:21096957752:web:0cf6a8d3556b40cb57a3cd",
            measurementId: "G-JMKM2MM8DN"
        };

        // Ensure __app_id is defined in the Canvas environment.
        // For deployed versions, use the appId from firebaseConfig if __app_id is not available.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;

        console.log("Firebase Config being used:", firebaseConfig);

        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

        const predefinedColors = [
            '#EF4444', '#22C55E', '#3B82F6', '#A855F7', '#F97316',
            '#14B8A6', '#6B7280', '#EAB308', '#EC4899', '#84CC16',
            '#06B6D4', '#6D28D9', '#BE123C', '#D97706', '#16A34A',
            '#DC2626', '#FBBF24', '#60A5FA', '#9333EA', '#FB923C',
        ];

        const tumblingSkillsOptions = [
            { level: "Fundamentals", skills: ["Foward roll", "Backroll", "Handstand", "Bridge", "Cartwheel", "Roundoff"] },
            { level: "Level 1", skills: ["Backbend", "Backwalkover", "Front walkover", "Valdez"] },
            { level: "Level 2", skills: ["Standing back handspring", "Front handspring/front bounder", "Standing multiple handspring", "Round off back handspring"] },
            { level: "Level 3", skills: ["Round off back tuck", "Round off back handspring back tuck", "Ariel"] },
            { level: "Level 4", skills: ["Standing back tuck", "Standing back handspring back tuck", "Round off back handspring layout"] },
            { level: "Level 5", skills: ["Round off backhandspring full", "Standing full"] }
        ];

        // Proficiency levels now mapped to a numerical range (0-100) with emojis
        const tumblingProficiencyMap = {
            "Don't have the skill yet": { range: [0, 33], display: "Cold üßä" }, // Changed emoji to üßä
            "With a little help": { range: [34, 66], display: "Warm ‚≠ê" }, // Changed emoji to ‚≠ê
            "Perfect by themselves": { range: [67, 100], display: "Hot üî•" }
        };

        const flyingSkillsOptions = {
            "Lt Leg Skills": ["Lt leg split", "Lt leg heel stretch", "Lt leg liberty", "Lt leg bow and arrow", "Lt leg scorpion", "Lt leg needle", "Lt leg arabesque"],
            "Rt Leg Skills": ["Rt leg split", "Rt leg heel stretch", "Rt leg liberty", "Rt leg bow and arrow", "Rt leg scorpion", "Rt leg needle", "Rt leg arabesque"]
        };

        // Proficiency levels now mapped to a numerical range (0-100) with emojis
        const flyingProficiencyMap = {
            "Stiff as a board": { range: [0, 33], display: "Cold üßä" }, // Changed emoji to üßä
            "Needs a little work": { range: [34, 66], display: "Warm ‚≠ê" }, // Changed emoji to ‚≠ê
            "Picture-perfect": { range: [67, 100], display: "Hot üî•" }
        };

        const focusCategories = [
            { name: "Flying Only", stars: "‚≠ê" },
            { name: "Tumbling Only", stars: "‚≠ê‚≠ê" },
            { name: "Both (Tumbling & Flying)", stars: "‚≠ê‚≠ê‚≠ê" },
            { name: "Tumbling & Basing", stars: "‚≠ê‚≠ê‚≠ê‚≠ê" }
        ];

        // State variables (simulated with global variables and render function)
        let students = [];
        let newStudentFirstName = '';
        let newStudentLastName = '';
        let newParentName = '';
        let newStudentPhone = '';
        let newParentPhone = '';
        // Store proficiency as a number (0-100)
        let newTumblingSkillProficiencies = []; // [{ skill: "Handstand", proficiency: 50 }]
        let newFlyingSkillProficiencies = []; // [{ skill: "Lt leg heel stretch", proficiency: 75 }]
        let newGoals = '';
        let newFocusCategory = focusCategories[0].name;
        let selectedColor = predefinedColors[0];
        let selectedDaysForNewStudent = [];
        let showModal = false;
        let modalMessage = '';
        let editingStudentId = null;
        let editingStudentFirstName = '';
        let editingStudentLastName = '';
        let editingParentName = '';
        let editingStudentPhone = '';
        let editingParentPhone = '';
        // Store proficiency as a number (0-100)
        let editingTumblingSkillProficiencies = [];
        let editingFlyingSkillProficiencies = [];
        let editingGoals = '';
        let editingFocusCategory = '';
        let editingStudentColor = '';
        let editingStudentDays = [];
        let expandedStudentId = null;

        let loginEmail = ''; // New: For login/signup
        let loginPassword = ''; // New: For login/signup

        function showCustomModal(message) {
            modalMessage = message;
            showModal = true;
            renderApp();
        }

        function closeCustomModal() {
            showModal = false;
            modalMessage = '';
            renderApp();
        }

        function displayLlmOutputModal(message) {
            llmOutputModalMessage = message;
            showLlmOutputModalState = true;
            renderApp();
        }

        function hideLlmOutputModal() {
            showLlmOutputModalState = false;
            llmOutputModalMessage = '';
            renderApp();
        }

        function generateTimeOptions() {
            const times = [];
            for (let hour = 8; hour <= 21; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const h = hour > 12 ? hour - 12 : hour;
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const m = minute === 0 ? '00' : minute;
                    const time = `${h}:${m} ${ampm}`;
                    times.push(time);
                }
            }
            return times;
        }
        const timeOptions = generateTimeOptions();

        function getStarsForCategory(categoryName) {
            const category = focusCategories.find(cat => cat.name === categoryName);
            return category ? category.stars : '';
        }

        function formatPhoneNumber(value) {
            if (!value) return '';
            const cleaned = value.replace(/\D/g, '');
            let formatted = '';
            if (cleaned.length > 0) { formatted += cleaned.substring(0, 3); }
            if (cleaned.length > 3) { formatted += '-' + cleaned.substring(3, 6); }
            if (cleaned.length > 6) { formatted += '-' + cleaned.substring(6, 10); }
            return formatted;
        }

        // Helper function to convert numerical proficiency to display string
        function getTumblingProficiencyDisplay(value) {
            if (value === null || value === undefined) return "Not rated";
            if (value >= tumblingProficiencyMap["Perfect by themselves"].range[0]) return tumblingProficiencyMap["Perfect by themselves"].display;
            if (value >= tumblingProficiencyMap["With a little help"].range[0]) return tumblingProficiencyMap["With a little help"].display;
            return tumblingProficiencyMap["Don't have the skill yet"].display;
        }

        function getFlyingProficiencyDisplay(value) {
            if (value === null || value === undefined) return "Not rated";
            if (value >= flyingProficiencyMap["Picture-perfect"].range[0]) return flyingProficiencyMap["Picture-perfect"].display;
            if (value >= flyingProficiencyMap["Needs a little work"].range[0]) return flyingProficiencyMap["Needs a little work"].display;
            return flyingProficiencyMap["Stiff as a board"].display;
        }

        // Helper function to convert proficiency string to numerical value for slider initialization
        function getTumblingProficiencyValue(proficiencyString) {
            if (proficiencyString === "Perfect by themselves") return 80; // Example mid-point for "Hot"
            if (proficiencyString === "With a little help") return 50; // Example mid-point for "Warm"
            if (proficiencyString === "Don't have the skill yet") return 20; // Example mid-point for "Cold"
            return 0; // Default to cold if not set
        }

        function getFlyingProficiencyValue(proficiencyString) {
            if (proficiencyString === "Picture-perfect") return 80;
            if (proficiencyString === "Needs a little work") return 50;
            if (proficiencyString === "Stiff as a board") return 20;
            return 0;
        }

        /**
         * Converts a time string (e.g., "9:00 AM", "5:30 PM") to minutes from midnight.
         * @param {string} timeStr - The time string.
         * @returns {number} Total minutes from midnight.
         */
        function convertTimeToMinutes(timeStr) {
            const [time, ampm] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (ampm === 'PM' && hours !== 12) {
                hours += 12;
            } else if (ampm === 'AM' && hours === 12) {
                hours = 0; // 12 AM is midnight
            }
            return hours * 60 + minutes;
        }

        /**
         * Converts total minutes from midnight back to a human-readable time string (e.g., "HH:MM AM/PM").
         * @param {number} totalMinutes - Total minutes from midnight.
         * @returns {string} Formatted time string.
         */
        function formatMinutesToTime(totalMinutes) {
            if (totalMinutes < 0 || totalMinutes >= 1440) return 'Invalid Time'; // 24 * 60 = 1440
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 === 0 ? 12 : hours % 12;
            const displayMinutes = minutes < 10 ? `0${minutes}` : minutes;

            return `${displayHours}:${displayMinutes} ${ampm}`;
        }

        /**
         * Parses a time range string (e.g., "9:00 AM - 10:00 AM") into start and end minutes from midnight.
         * @param {string} timeRangeString - The time range string.
         * @returns {{start: number, end: number}} An object with start and end times in minutes.
         */
        function parseTimeRange(timeRangeString) {
            if (!timeRangeString || timeRangeString.indexOf(' - ') === -1) {
                return { start: -1, end: -1 }; // Invalid time range
            }
            const [startTimeStr, endTimeStr] = timeRangeString.split(' - ');
            const startMinutes = convertTimeToMinutes(startTimeStr.trim());
            const endMinutes = convertTimeToMinutes(endTimeStr.trim());
            return { start: startMinutes, end: endMinutes };
        }

        /**
         * Checks if two time ranges overlap.
         * @param {{start: number, end: number}} range1 - The first time range.
         * @param {{start: number, end: number}} range2 - The second time range.
         * @returns {boolean} True if the ranges overlap, false otherwise.
         */
        function checkOverlap(range1, range2) {
            // An overlap occurs if the start of one range is before the end of the other,
            // AND the start of the other range is before the end of the first.
            return range1.start < range2.end && range2.start < range1.end;
        }


        // --- Firebase Initialization and Authentication ---
        async function initializeFirebaseAndAuth() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Set up the auth state change listener FIRST
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email; // Store email if available
                        console.log("Auth state changed: User ID set to", userId, "Email:", userEmail);
                    } else {
                        userId = crypto.randomUUID(); // Fallback to anonymous ID
                        userEmail = null;
                        console.log("Auth state changed: Anonymous User ID set.");
                    }
                    isAuthReady = true;
                    setupFirestoreListener(); // Setup listener once auth is ready
                    renderApp(); // Initial render after auth is ready
                });

                // Attempt custom token sign-in if available (Canvas environment)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } catch (authError) {
                        console.warn("Custom token mismatch. The provided custom token is invalid. Attempting anonymous sign-in as a fallback.");
                        showCustomModal(
                            `Authentication failed: The provided custom token is invalid. ` +
                            `The app will attempt to sign in anonymously to proceed. ` +
                            `You can still use the planner, but data will be tied to an anonymous user ID. ` +
                            `(Error: ${escapeTemplateLiteral(authError.message)})`
                        );
                        await signInAnonymously(auth); // Fallback to anonymous
                        console.log("Signed in anonymously after custom token mismatch.");
                    }
                } else {
                    // If no custom token, and no user is currently logged in, sign in anonymously
                    // This handles cases where the user might have previously signed out or is new.
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (no custom token provided and no existing user).");
                    }
                }

            } catch (overallError) {
                console.error("Overall Firebase initialization error:", overallError);
                showCustomModal(`Firebase setup error: ${escapeTemplateLiteral(overallError.message)}`);
                isAuthReady = true;
                renderApp();
            }
        }

        // --- Email/Password Authentication Functions ---
        async function handleSignUp(event) {
            event.preventDefault();
            if (!loginEmail || !loginPassword) {
                showCustomModal("Please enter both email and password for sign up.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, loginEmail, loginPassword);
                showCustomModal("Account created successfully! You are now signed in.");
                loginEmail = '';
                loginPassword = '';
            } catch (error) {
                console.error("Error signing up:", error);
                showCustomModal(`Sign up failed: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        async function handleSignIn(event) {
            event.preventDefault();
            if (!loginEmail || !loginPassword) {
                showCustomModal("Please enter both email and password for sign in.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
                showCustomModal("Signed in successfully!");
                loginEmail = '';
                loginPassword = '';
            } catch (error) {
                console.error("Error signing in:", error);
                showCustomModal(`Sign in failed: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showCustomModal("Signed out successfully!");
                // After sign out, onAuthStateChanged will trigger, setting userId to a new anonymous ID
            } catch (error) {
                console.error("Error signing out:", error);
                showCustomModal(`Sign out failed: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        // --- Firestore Data Listener ---
        function setupFirestoreListener() {
            if (!isAuthReady || !db || !userId) {
                console.log("Skipping Firestore listener setup: Auth not ready or userId not available.");
                return;
            }

            console.log("Setting up Firestore listener for userId:", userId);
            const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);

            onSnapshot(studentsCollectionRef, (snapshot) => {
                students = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const assignedDays = (data.assignedDays || []).map(item => {
                        if (typeof item === 'string') {
                            // Default to a 1-hour slot if only day was saved previously
                            return { day: item, startTime: '9:00 AM', endTime: '10:00 AM' };
                        } else if (item.time) {
                            // If old data has 'time' as a single string, parse it
                            const [start, end] = item.time.split(' - ').map(t => t.trim());
                            return { day: item.day, startTime: start, endTime: end };
                        }
                        return item; // Already in {day, startTime, endTime} format
                    });

                    // Ensure tumblingSkillProficiencies store numerical values.
                    // If old string data exists, convert it to a default numerical value.
                    let tumblingSkillProficiencies = [];
                    if (Array.isArray(data.tumblingSkillProficiencies)) {
                        tumblingSkillProficiencies = data.tumblingSkillProficiencies.map(item => ({
                            skill: item.skill,
                            proficiency: typeof item.proficiency === 'number' ? item.proficiency : getTumblingProficiencyValue(item.proficiency)
                        }));
                    } else if (typeof data.tumblingSkills === 'string' && data.tumblingSkills.trim() !== '') {
                        tumblingSkillProficiencies = [{ skill: data.tumblingSkills.trim(), proficiency: getTumblingProficiencyValue(data.tumblingSkills.trim()) }];
                    }

                    // Ensure flyingSkillProficiencies store numerical values.
                    // If old string data exists, convert it to a default numerical value.
                    let flyingSkillProficiencies = [];
                    if (Array.isArray(data.flyingSkillProficiencies)) {
                        flyingSkillProficiencies = data.flyingSkillProficiencies.map(item => ({
                            skill: item.skill,
                            proficiency: typeof item.proficiency === 'number' ? item.proficiency : getFlyingProficiencyValue(item.proficiency)
                        }));
                    } else if (typeof data.flyingSkills === 'string' && data.flyingSkills.trim() !== '') {
                        flyingSkillProficiencies = [{ skill: data.flyingSkills.trim(), proficiency: getFlyingProficiencyValue(data.flyingSkills.trim()) }];
                    }

                    return {
                        id: doc.id,
                        firstName: data.firstName || '',
                        lastName: data.lastName || '',
                        parentName: data.parentName || '',
                        studentPhone: data.studentPhone || '',
                        parentPhone: data.parentPhone || '',
                        tumblingSkillProficiencies: tumblingSkillProficiencies,
                        flyingSkillProficiencies: flyingSkillProficiencies,
                        goals: data.goals || '',
                        focusCategory: data.focusCategory || focusCategories[0].name,
                        color: data.color || predefinedColors[0],
                        assignedDays: assignedDays
                    };
                });
                console.log("Students fetched:", students);
                renderApp();
            }, (error) => {
                console.error("Error fetching students:", error);
                showCustomModal(`Error loading students: ${escapeTemplateLiteral(error.message)}`);
            });
        }

        // --- LLM Integration Functions ---
        async function callGeminiAPI(prompt) {
            isLoadingLLM = true;
            renderApp(); // Show loading spinner

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return text;
                } else {
                    console.error("Unexpected LLM response structure:", result);
                    throw new Error("Failed to get a valid response from the LLM.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showCustomModal(`Error generating content: ${escapeTemplateLiteral(error.message)}`);
                return null;
            } finally {
                isLoadingLLM = false;
                renderApp(); // Hide loading spinner
            }
        }

        // Removed suggestGoals function as per user request
        // async function suggestGoals(isEditing) { ... }

        // Removed generateLessonPlan function as per user request
        // async function generateLessonPlan(isEditing) { ... }

        // --- Event Handlers for Student Data ---
        async function handleAddStudent(event) {
            event.preventDefault();
            if (!newStudentFirstName.trim() || !newStudentLastName.trim() || !userId) {
                showCustomModal("Please enter student's first and last name, and ensure you are logged in.");
                return;
            }

            const fullName = `${newStudentFirstName.trim()} ${newStudentLastName.trim()}`;
            const nameExists = students.some(student => `${student.firstName} ${student.lastName}`.toLowerCase() === fullName.toLowerCase());
            if (nameExists) {
                showCustomModal("A student with this full name already exists. Please choose a different name.");
                return;
            }

            const newStudent = {
                firstName: newStudentFirstName.trim(),
                lastName: newStudentLastName.trim(),
                parentName: newParentName.trim(),
                studentPhone: newStudentPhone.trim(),
                parentPhone: newParentPhone.trim(),
                tumblingSkillProficiencies: newTumblingSkillProficiencies, // Now stores numerical values
                flyingSkillProficiencies: newFlyingSkillProficiencies,   // Now stores numerical values
                goals: newGoals.trim(),
                focusCategory: newFocusCategory,
                color: selectedColor,
                assignedDays: selectedDaysForNewStudent,
            };

            try {
                const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
                await addDoc(studentsCollectionRef, newStudent);
                newStudentFirstName = '';
                newStudentLastName = '';
                newParentName = '';
                newStudentPhone = '';
                newParentPhone = '';
                newTumblingSkillProficiencies = []; // Reset to empty array
                newFlyingSkillProficiencies = [];   // Reset to empty array
                newGoals = '';
                newFocusCategory = focusCategories[0].name;
                selectedColor = predefinedColors[0];
                selectedDaysForNewStudent = [];
                renderApp();
            } catch (error) {
                console.error("Error adding student:", error);
                showCustomModal(`Error adding student: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        async function handleUpdateStudent(event) {
            event.preventDefault();
            if (!editingStudentFirstName.trim() || !editingStudentLastName.trim() || !userId || !editingStudentId) {
                showCustomModal("Please enter student's first and last name, and ensure a student is selected for editing.");
                return;
            }

            const updatedFullName = `${editingStudentFirstName.trim()} ${editingStudentLastName.trim()}`;
            const nameExists = students.some(
                student => student.id !== editingStudentId && `${student.firstName} ${student.lastName}`.toLowerCase() === updatedFullName.toLowerCase()
            );
            if (nameExists) {
                showCustomModal("Another student with this full name already exists. Please choose a different name.");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, editingStudentId);
                await updateDoc(studentDocRef, {
                    firstName: editingStudentFirstName.trim(),
                    lastName: editingStudentLastName.trim(),
                    parentName: editingParentName.trim(),
                    studentPhone: editingStudentPhone.trim(),
                    parentPhone: editingParentPhone.trim(),
                    tumblingSkillProficiencies: editingTumblingSkillProficiencies, // Now stores numerical values
                    flyingSkillProficiencies: editingFlyingSkillProficiencies,   // Now stores numerical values
                    goals: editingGoals.trim(),
                    focusCategory: editingFocusCategory,
                    color: editingStudentColor,
                    assignedDays: editingStudentDays,
                });
                editingStudentId = null;
                editingStudentFirstName = '';
                editingStudentLastName = '';
                editingParentName = '';
                editingStudentPhone = '';
                editingParentPhone = '';
                editingTumblingSkillProficiencies = [];
                editingFlyingSkillProficiencies = [];
                editingGoals = '';
                editingFocusCategory = '';
                editingStudentColor = '';
                editingStudentDays = [];
                renderApp();
            } catch (error) {
                console.error("Error updating student:", error);
                showCustomModal(`Error updating student: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        async function handleDeleteStudent(studentIdToDelete) {
            try {
                const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, studentIdToDelete);
                await deleteDoc(studentDocRef);
            } catch (error) {
                console.error("Error deleting student:", error);
                showCustomModal(`Error deleting student: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        function toggleDayForNewStudent(day) {
            const existingDay = selectedDaysForNewStudent.find(item => item.day === day);
            if (existingDay) {
                selectedDaysForNewStudent = selectedDaysForNewStudent.filter(item => item.day !== day);
            } else {
                selectedDaysForNewStudent = [...selectedDaysForNewStudent, { day: day, startTime: '8:00 AM', endTime: '8:30 AM' }];
            }
            renderApp();
        }

        function handleTimeChangeForNewStudent(day, type, time) {
            selectedDaysForNewStudent = selectedDaysForNewStudent.map(item => {
                if (item.day === day) {
                    return { ...item, [type]: time };
                }
                return item;
            });
            renderApp(); // Add this to re-render the UI after state update
        }

        function toggleDayForEditingStudent(day) {
            const existingDay = editingStudentDays.find(item => item.day === day);
            if (existingDay) {
                editingStudentDays = editingStudentDays.filter(item => item.day !== day);
            } else {
                editingStudentDays = [...editingStudentDays, { day: day, startTime: '8:00 AM', endTime: '8:30 AM' }];
            }
            renderApp();
        }

        function handleTimeChangeForEditingStudent(day, type, time) {
            editingStudentDays = editingStudentDays.map(item => {
                if (item.day === day) {
                    return { ...item, [type]: time };
                }
                return item;
            });
            renderApp(); // Add this to re-render the UI after state update
        }

        // Handle proficiency change from slider (now takes numerical value)
        function handleTumblingSkillChange(skill, proficiencyValue, isEditing = false, displayElement = null, sliderElement = null) {
            let targetArray = isEditing ? editingTumblingSkillProficiencies : newTumblingSkillProficiencies;
            const existingSkillIndex = targetArray.findIndex(item => item.skill === skill);

            if (existingSkillIndex !== -1) {
                targetArray[existingSkillIndex].proficiency = proficiencyValue;
            } else {
                targetArray.push({ skill: skill, proficiency: proficiencyValue });
            }

            // Update the state variable directly (no need for ...targetArray spread here as it's already a reference)
            if (isEditing) {
                editingTumblingSkillProficiencies = targetArray;
            } else {
                newTumblingSkillProficiencies = targetArray;
            }

            // Directly update the display element without re-rendering the whole app
            if (displayElement) {
                displayElement.textContent = getTumblingProficiencyDisplay(proficiencyValue);
            }

            // Update slider thumb class based on value
            if (sliderElement) {
                sliderElement.classList.remove('slider-cold-value', 'slider-warm-value', 'slider-hot-value'); // Remove all first
                if (proficiencyValue >= tumblingProficiencyMap["Perfect by themselves"].range[0]) {
                    sliderElement.classList.add('slider-hot-value');
                } else if (proficiencyValue >= tumblingProficiencyMap["With a little help"].range[0]) {
                    sliderElement.classList.add('slider-warm-value');
                } else {
                    sliderElement.classList.add('slider-cold-value');
                }
            }
        }

        function handleFlyingSkillChange(skill, proficiencyValue, isEditing = false, displayElement = null, sliderElement = null) {
            let targetArray = isEditing ? editingFlyingSkillProficiencies : newFlyingSkillProficiencies;
            const existingSkillIndex = targetArray.findIndex(item => item.skill === skill);

            if (existingSkillIndex !== -1) {
                targetArray[existingSkillIndex].proficiency = proficiencyValue;
            } else {
                targetArray.push({ skill: skill, proficiency: proficiencyValue });
            }

            // Update the state variable directly
            if (isEditing) {
                editingFlyingSkillProficiencies = targetArray;
            } else {
                newFlyingSkillProficiencies = targetArray;
            }

            // Directly update the display element without re-rendering the whole app
            if (displayElement) {
                displayElement.textContent = getFlyingProficiencyDisplay(proficiencyValue);
            }

            // Update slider thumb class based on value
            if (sliderElement) {
                sliderElement.classList.remove('slider-cold-value', 'slider-warm-value', 'slider-hot-value'); // Remove all first
                if (proficiencyValue >= flyingProficiencyMap["Picture-perfect"].range[0]) {
                    sliderElement.classList.add('slider-hot-value');
                } else if (proficiencyValue >= flyingProficiencyMap["Needs a little work"].range[0]) {
                    sliderElement.classList.add('slider-warm-value');
                } else {
                    sliderElement.classList.add('slider-cold-value');
                }
            }
        }

        function startEditing(student) {
            editingStudentId = student.id;
            editingStudentFirstName = student.firstName;
            editingStudentLastName = student.lastName;
            editingParentName = student.parentName;
            editingStudentPhone = student.studentPhone;
            editingParentPhone = student.parentPhone;
            // Ensure proficiencies are numerical values for the sliders
            editingTumblingSkillProficiencies = JSON.parse(JSON.stringify(student.tumblingSkillProficiencies || []));
            editingFlyingSkillProficiencies = JSON.parse(JSON.stringify(student.flyingSkillProficiencies || []));
            editingGoals = student.goals;
            editingFocusCategory = student.focusCategory;
            editingStudentColor = student.color;
            editingStudentDays = (student.assignedDays || []).map(item => {
                // Ensure assignedDays are in {day, startTime, endTime} format for editing
                if (typeof item === 'string') {
                    return { day: item, startTime: '8:00 AM', endTime: '8:30 AM' };
                } else if (item.time) {
                    const [start, end] = item.time.split(' - ').map(t => t.trim());
                    return { day: item.day, startTime: start, endTime: end };
                }
                return item;
            });
            renderApp();
        }

        function toggleStudentDetails(studentId) {
            expandedStudentId = (expandedStudentId === studentId) ? null : studentId;
            renderApp();
        }

        // --- New: Submission Link and Pending Submissions Logic ---
        function generateShareLink() {
            if (!userId) {
                showCustomModal("Please sign in to generate a shareable link.");
                return;
            }
            // Assumes submission.html is in the same directory as index.html
            // If your GitHub Pages URL is like `https://username.github.io/repo-name/`,
            // then `window.location.origin` will be `https://username.github.io`
            // and `window.location.pathname` will be `/repo-name/index.html`.
            // We need to construct the path to submission.html correctly.
            const baseUrl = window.location.origin;
            const pathSegments = window.location.pathname.split('/');
            // Find the repository name part if it's a project page
            // e.g., /repo-name/index.html -> /repo-name/
            // e.g., /index.html -> /
            let repoPath = '';
            if (pathSegments.length > 1 && pathSegments[1] !== '') {
                // If it's a project page, the second segment is usually the repo name
                repoPath = `/${pathSegments[1]}/`;
            }

            // Construct the full URL to submission.html
            const submissionPagePath = `${repoPath}submission.html`;
            submissionShareLink = `${baseUrl}${submissionPagePath}?ownerId=${userId}`;
            renderApp(); // Re-render to display the link

            // Automatically copy to clipboard
            copyShareLinkToClipboard();
        }

        function copyShareLinkToClipboard() {
            const linkInput = document.getElementById('submissionShareLinkInput');
            if (linkInput) {
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // For mobile devices
                document.execCommand('copy'); // Fallback for older browsers, works in iframes
                showCustomModal("Link copied to clipboard!");
            } else {
                showCustomModal("Could not find the link to copy.");
            }
        }

        async function handleApproveSubmission(submission) {
            try {
                // 1. Add to main students collection
                const newStudentData = {
                    firstName: submission.firstName || '',
                    lastName: submission.lastName || '',
                    parentName: submission.parentName || '',
                    studentPhone: submission.studentPhone || '',
                    parentPhone: submission.parentPhone || '',
                    goals: submission.goals || '',
                    // Default values for skills and focus category as they are not in submission form
                    tumblingSkillProficiencies: [],
                    flyingSkillProficiencies: [],
                    focusCategory: focusCategories[0].name,
                    color: predefinedColors[0], // Assign a default color
                    assignedDays: [] // No assigned days from submission form
                };
                const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
                await addDoc(studentsCollectionRef, newStudentData);

                // 2. Delete from pending submissions - UPDATED PATH
                const pendingSubmissionDocRef = doc(db, `artifacts/${appId}/public_submissions/${userId}/pendingStudents`, submission.id);
                await deleteDoc(pendingSubmissionDocRef);

                showCustomModal(`${submission.firstName} ${submission.lastName} approved and added to your students!`);
            } catch (error) {
                console.error("Error approving submission:", error);
                showCustomModal(`Error approving submission: ${escapeTemplateLiteral(error.message)}`);
            }
        }

        async function handleRejectSubmission(submissionId) {
            try {
                // Delete from pending submissions - UPDATED PATH
                const pendingSubmissionDocRef = doc(db, `artifacts/${appId}/public_submissions/${userId}/pendingStudents`, submissionId);
                await deleteDoc(pendingSubmissionDocRef);
                showCustomModal("Submission rejected and removed.");
            } catch (error) {
                console.error("Error rejecting submission:", error);
                showCustomModal(`Error rejecting submission: ${escapeTemplateLiteral(error.message)}`);
            }
        }


        // --- Main Render Function ---
        function renderApp() {
            const appDiv = document.getElementById('app');
            let htmlContent = '';

            if (!isAuthReady) {
                htmlContent = `
                    <div id="loading-spinner" class="flex flex-col items-center justify-center h-64">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-lg text-gray-700">Loading planner...</p>
                        <p class="text-sm text-gray-500 mt-2">Please wait while we connect to your data.</p>
                    </div>
                `;
            } else {
                htmlContent = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Student Submission Form</h1>

                    <p class="text-gray-700 text-center mb-6">Please fill out this form to submit your information to the student planner.</p>

                    <form id="student-submission-form" class="mb-8 p-4 border border-gray-200 rounded-lg bg-white shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Your Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="firstName" class="label">Student First Name:</label>
                                <input type="text" id="firstName" class="input-field" placeholder="e.g., Alex" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="label">Student Last Name:</label>
                                <input type="text" id="lastName" class="input-field" placeholder="e.g., Johnson" required>
                            </div>
                            <div class="form-group">
                                <label for="studentPhone" class="label">Student Phone Number:</label>
                                <input type="tel" id="studentPhone" class="input-field" placeholder="e.g., 555-123-4567" pattern="\\d{3}-\\d{3}-\\d{4}" title="Phone number format: ###-###-####">
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Parent/Guardian Information (Optional)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label for="parentName" class="label">Parent/Guardian Name:</label>
                                    <input type="text" id="parentName" class="input-field" placeholder="e.g., Chris Johnson">
                                </div>
                                <div class="form-group">
                                    <label for="parentPhone" class="label">Parent/Guardian Phone Number:</label>
                                    <input type="tel" id="parentPhone" class="input-field" placeholder="e.g., 555-987-6543" pattern="\\d{3}-\\d{3}-\\d{4}" title="Phone number format: ###-###-####">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Your Goals (Optional)</h3>
                            <div class="form-group">
                                <label for="goals" class="label">What are your main goals or things you'd like to learn/improve?</label>
                                <textarea id="goals" class="input-field h-24" placeholder="e.g., Master back handspring, improve flexibility, learn a full twist"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-center mt-8">
                            <button type="submit" class="btn btn-blue text-lg px-8 py-3 rounded-lg shadow-lg hover:shadow-xl">Submit My Information</button>
                        </div>
                    </form>

                    <!-- General Modal for messages -->
                    ${showModal ? `
                        <div class="modal">
                            <div class="modal-content">
                                <h3>${escapeTemplateLiteral(modalMessage.includes('Error') ? 'Error' : 'Notification')}</h3>
                                <p>${escapeTemplateLiteral(modalMessage)}</p>
                                <button type="button" class="btn btn-blue" onclick="closeCustomModal()">OK</button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- LLM Loading Spinner Modal (if applicable, though not used in submission form usually) -->
                    ${isLoadingLLM ? `
                        <div class="modal">
                            <div class="modal-content flex flex-col items-center justify-center">
                                <div class="loading-spinner"></div>
                                <p class="mt-4 text-lg text-gray-700">Submitting your information...</p>
                                <p class="text-sm text-gray-500 mt-2">This may take a moment.</p>
                            </div>
                        </div>
                    ` : ''}
                `;
            }

            appDiv.innerHTML = htmlContent;

            // --- Attach Event Listeners (MUST be done after innerHTML update) ---
            if (isAuthReady) {
                const submissionForm = document.getElementById('student-submission-form');
                if (submissionForm) {
                    submissionForm.onsubmit = handleSubmit;

                    // Format phone numbers as user types
                    const studentPhoneInput = document.getElementById('studentPhone');
                    studentPhoneInput.oninput = (e) => { e.target.value = formatPhoneNumber(e.target.value); };

                    const parentPhoneInput = document.getElementById('parentPhone');
                    parentPhoneInput.oninput = (e) => { e.target.value = formatPhoneNumber(e.target.value); };
                }
            }

            if (showModal) {
                const modalButton = appDiv.querySelector('.modal button');
                if (modalButton) { modalButton.onclick = closeCustomModal; }
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            initializeFirebaseAndAuth();
            renderApp();
        };

        // --- Submission Logic ---
        async function handleSubmit(event) {
            event.preventDefault();

            // Extract ownerId from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const ownerId = urlParams.get('ownerId');

            if (!ownerId) {
                showCustomModal("Error: Missing owner ID in URL. Please use the shareable link provided by your coach.");
                return;
            }

            isLoadingLLM = true; // Use LLM spinner for submission to indicate processing
            renderApp();

            const submissionData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                studentPhone: document.getElementById('studentPhone').value.trim(),
                parentName: document.getElementById('parentName').value.trim(),
                parentPhone: document.getElementById('parentPhone').value.trim(),
                goals: document.getElementById('goals').value.trim(),
                submissionDate: new Date().toISOString(), // Record submission time
            };

            try {
                // Path to the pending students collection in the owner's public artifacts
                // This collection will be created under /artifacts/{appId}/public_submissions/{ownerId}/pendingStudents
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/public_submissions/${ownerId}/pendingStudents`);
                await addDoc(submissionsCollectionRef, submissionData);
                showCustomModal("Your information has been submitted successfully!");
                // Clear form fields after submission
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('studentPhone').value = '';
                document.getElementById('parentName').value = '';
                document.getElementById('parentPhone').value = '';
                document.getElementById('goals').value = '';

            } catch (error) {
                console.error("Submission failed:", error);
                showCustomModal(`Submission failed: ${escapeTemplateLiteral(error.message)}`);
            } finally {
                isLoadingLLM = false;
                renderApp();
            }
        }
    </script>
</body>
</html>
```

**Here's what to do:**

1.  **Open your local `submission.html` file:** Make sure you open the actual file you're using for your GitHub repository.
2.  **Replace the content:** Copy *all* the code from the `student-submission-html` Canvas above and paste it into your local `submission.html` file, replacing everything that's currently in it.
3.  **Save the file:** Save the changes to `submission.html`.
4.  **Commit and Push to GitHub:** Upload this updated `submission.html` to your GitHub repository.
5.  **Clear Browser Cache (Important!):** After GitHub Pages deploys the new version (which can take a few minutes), clear your browser's cache, or open the link in a new **incognito/private browsing window**. This ensures you're loading the *latest* version of your `submission.html` from GitHub Pages, not a cached old one.
6.  **Re-verify Firebase Security Rules:** Just to be absolutely sure, double-check your Firebase Firestore security rules one more time. They should look like this:

    ```firestore
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // Rule for private user data (your students)
        match /artifacts/{appId}/users/{userId}/students/{documentId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // Rule for public pending submissions (MUST match the path in your code)
        match /artifacts/{appId}/public_submissions/{userId}/pendingStudents/{documentId} {
          allow read, write: if request.auth != null;
        }

        // General rule for private artifacts
        match /artifacts/{appId}/users/{userId}/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // General rule for public artifacts
        match /artifacts/{appId}/public/{document=**} {
          allow read, write: if request.auth != null;
        }
      }
    }
    ```

    Ensure the `public_submissions` part is exactly as shown. If you had `public/submissions` in your rules, it would still cause an issue.

I believe that once the `submission.html` file you're running actually reflects the `public_submissions` change and your security rules are updated accordingly, this error will be resolv
